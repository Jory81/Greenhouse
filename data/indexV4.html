<!DOCTYPE html>
<html>
<head>
<script src="https://code.jquery.com/jquery.min.js"></script>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="styleV4.css"> 
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
</head>
<body>
<br>
<div class='time-frame'>
	<div>
    <span id='date-part'></span>
    <span> &nbsp  / &nbsp  </span>
    <span id='time-part'></span>
	
	<span id="checkbox4">
	<input class="ckeckbox-element" type="checkbox" id="1I1" onclick="updateButton('1I1')"/>  
	<i class="glyphicon glyphicon-volume-off"></i>
	</span>  
	
	</div>
	
	<div>	
	<h3>settings:</h3>
	</div>
	<div>	
	<span class="dht-labels">temperature</span>
	<span class="tab">
	<span id="checkbox3">
	<input class="ckeckbox-element" type="checkbox" id="1Z1" onclick="openTab('1Z1', event, 'tempcontrol')"/>  
	<i class="glyphicon glyphicon-pencil"></i>
	</span>

	<span class="dht-labels">humidty</span>
	<span class="tab">
	<span id="checkbox3">
	<input class="ckeckbox-element" type="checkbox" id="1Z2" onclick="openTab('1Z2', event, 'humidcontrol')"/>  
	<i class="glyphicon glyphicon-pencil"></i>
	</span>	
		
	<span class="dht-labels">air flow</span>
	<span class="tab">
	<span id="checkbox3">
	<input class="ckeckbox-element" type="checkbox" id="1Z3" onclick="openTab('1Z3', event, 'fancontrol')"/>  
	<i class="glyphicon glyphicon-pencil"></i>
	</span>	
	
	<span class="dht-labels">lights</span>
	<span class="tab">
	<span id="checkbox3">
	<input class="ckeckbox-element" type="checkbox" id="1Z4" onclick="openTab('1Z4', event, 'lightcontrol')"/>  
	<i class="glyphicon glyphicon-pencil"></i>
	</span>	
	<div>
	
	<span class="dht-labels">relay control</span>
	<span class="tab">
	<span id="checkbox3">
	<input class="ckeckbox-element" type="checkbox" id="1Z5" onclick="openTab('1Z5', event, 'relaycontrol')"/>  
	<i class="glyphicon glyphicon-pencil"></i>
	</span>	
	
	<span class="dht-labels">system settings</span>
	<span class="tab">
	<span id="checkbox3">
	<input class="ckeckbox-element" type="checkbox" id="1Z6" onclick="openTab('1Z6', event, 'systemsettings')"/>  
	<i class="glyphicon glyphicon-pencil"></i>
	</span>
	
	<span class="dht-labels">calibration</span>
	<span class="tab">
	<span id="checkbox3">
	<input class="ckeckbox-element" type="checkbox" id="1Z7" onclick="openTab('1Z7', event, 'calsettings')"/>  
	<i class="glyphicon glyphicon-pencil"></i>
	</span>

	</div>
</div>
<hr>


	<div class="inputcontainer">
		<span class="inputparam"> <input type="text" placeholder="input Wifi ID" class="form-controlx input-sl" id="ssid" value=""></span> <span><button onclick="updateTemp('I')" class="btnx btn-primary">_submit</button> </span>	<span id="SSID"></span>
	</div>
	<div class="inputcontainer">
		<span class="inputparam"> <input type="text" placeholder="input Wifi pass" class="form-controlx input-sl" id="pass" value=""></span> <span><button onclick="updateTemp('P')" class="btnx btn-primary">_submit</button> </span>	<span id="PASS"></span>
	</div>

	<div>
	<span id="checkbox1">reboot &nbsp
	<input class="ckeckbox-element" type="checkbox" id="1U1" onclick="updateButton('1U1')"/>  
	<i class="glyphicon glyphicon-refresh"></i>
	</span> 
	</div>	
	<hr>
</div>

	<div class="inline">
		<h3>climate 1</h3>
		
		<p>
		<span class="dht-labels">Soil temp:</span> 
		<span id="temperature1"></span>
		<sup class="units">&deg;C</sup>
		<span id="checkbox4">
		<input class="ckeckbox-element" type="checkbox" id="heater1" onclick="updateButton(this.id, this.checked)" />  
		&nbsp;
		<i class="fas fa-thermometer-half"></i>
		</span> 
		</p>	
		
		<p>
		<span class="dht-labels">Air temp:</span> 
		<span id="temperature6"></span>
		<sup class="units">&deg;C</sup>	
		</p>
		
		<p>		
		<span class="dht-labels">Fanspeed</span> 		
		<span id="fanspeed1"></span>
		<span class="dht-labels">%</span> 	
		<span id="checkbox2">
		<input class="ckeckbox-element" type="checkbox" id="fan1" onclick="updateButton(this.id, this.checked)"/>  
		&nbsp;
		<i class="fas fa-atom"></i>
		</span> 
		</p>
		
		<p>
		<span class="dht-labels">Rel. humidity: </span> 
		<span id="humidity1"></span>
		<span class="units">(%)</span>	
		<span id="checkbox1">
		<input class="ckeckbox-element" type="checkbox" id="humidifier1" onclick="updateButton(this.id, this.checked)"/>  
		&nbsp
		<i class="glyphicon glyphicon-leaf"></i>
		</span> 
		</p>
		
		<p>
		<span class="dht-labels">light schedule: </span>
		<span><input class="timeMakeup" type="time"id="lights1ON"></span><span><input class="timeMakeup" type="time" id="lights1OFF"></span>
		<span id="checkbox5">
		<input class="ckeckbox-element" type="checkbox" id="lights1" onclick="updateButton(this.id, this.checked)"/>  
		&nbsp;
		<i class="glyphicon glyphicon-asterisk"></i>
		</span> 
		</p>
		<br>
		
		<p>
		<span class="dht-labels">additional temp. sensor 2:</span> 
		<span id="temperature2"></span>
		<sup class="units">&deg;C</sup>	
		</p>
	</div>

	<div class="inline">
		<h3>climate 2</h3>
		
		<p>
		<span class="dht-labels">Soil temp:</span> 
		<span id="temperature3"></span>
		<sup class="units">&deg;C</sup>
		<span id="checkbox4">
		<input class="ckeckbox-element" type="checkbox" id="heater2" onclick="updateButton(this.id, this.checked)"/>  
		&nbsp;
		<i class="fas fa-thermometer-half"></i>
		</span> 
		</p>	
		
		<p>
		<span class="dht-labels">Air temp:</span> 
		<span id="temperature7"></span>
		<sup class="units">&deg;C</sup>
			
		</p>
		<p>		
		<span class="dht-labels">Fanspeed</span> 		
		<span id="fanspeed2"></span>
		<span class="dht-labels">%</span> 		
		<span id="checkbox2">
		<input class="ckeckbox-element" type="checkbox" id="fan2" onclick="updateButton(this.id, this.checked)"/>  
		&nbsp;
		<i class="fas fa-atom"></i>
		</span> 
		</p>
		
		<p>
		<span class="dht-labels">Rel. humidity: </span> 
		<span id="humid1"></span>
		<span class="units">(%)</span>	
		<span id="checkbox1">
		<input class="ckeckbox-element" type="checkbox" id="humidifier2" onclick="updateButton(this.id, this.checked)"/>  
		&nbsp
		<i class="glyphicon glyphicon-leaf"></i>
		</span> 
		</p>
		
		<p>
		<span class="dht-labels">light schedule: </span>
		<span><input class="timeMakeup" type="time"id="lights2ON"></span><span><input class="timeMakeup" type="time" id="lights2OFF"></span>
		<span id="checkbox5">
		<input class="ckeckbox-element" type="checkbox" id="lights2" onclick="updateButton(this.id, this.checked)"/>  
		&nbsp;
		<i class="glyphicon glyphicon-asterisk"></i>
		</span> 
		</p>
		
		<p>
		<span class="dht-labels">additional temp. sensor 2:</span> 
		<span id="temperature4"></span>
		<sup class="units">&deg;C</sup>			
		</p>

	</div>
	<hr>

    <div id="chart-temperature1" class="container"></div>
	
	<div id="chart-temperature2" class="container"></div>
	<hr>
	
<script>	

var gateway = `ws://${window.location.hostname}/ws`;
var websocket;

console.log(gateway);

var k = 10;
var residuFloat = 0; 

var humidmin = 30;
var humidmax = 80;
var humidmin2 = 30;
var humidmax2 = 80;

var hourStart = 05;
var minuteStart = 30;
var hourStop = 20;
var minuteStop = 30;

var hourStart2 = 05;
var minuteStart2 = 30;
var hourStop2 = 20;
var minuteStop2 = 30;

var targetCelsius1=0;
var targetCelsius2=0;
var targetCelsius3=0;
var targetCelsius4=0;

var offsetFromTargetTempMax=0;
var offsetFromTargetTempMin=0;
var offsetFromTargetTempMax2=0;
var offsetFromTargetTempMin2=0;

var fanSpeed1=0;
var fanSpeed2=0;

var humidity1=0;
var humidity2=0;

var soiltemp1=0;
var soiltemp2=0;

var airtemp1=0;
var airtemp2=0;

var timer1Counter=0;
var timer2Counter=0;
var numberofRingsAlarm1=0;
var numberofRingsAlarm2=0;
var refreshIntervalId1=0;
var refreshIntervalId2=0;

window.addEventListener('load', onLoad);

function onLoad(event) {
	
    initWebSocket();
//    initButton();
}

// ----------------------------------------------------------------------------
// WebSocket handling
// ----------------------------------------------------------------------------

function initWebSocket() {
    console.log('Trying to open a WebSocket connection...');
    websocket = new WebSocket(gateway);
    websocket.onopen    = onOpen;
    websocket.onclose   = onClose;
    websocket.onmessage = onMessage;
}
 
// Called when a WebSocket connection is established with the server

function onOpen(event) {
 
    // Log connection state
    console.log("Connected");
	//document.getElementById("SetTab2").style.display = "none";	
	document.getElementById("1U1").checked = true;
	k = 0;
	doSend("GGG"+k);

}
 
// Called when the WebSocket connection is closed
function onClose(event) {
    console.log('Connection closed');
    setTimeout(initWebSocket, 2000);
}

function updateNumber(key, value) {
	var field = key;
	var obj = {};
	obj[field] = value;
	var myJSON = JSON.stringify(obj);
	websocket.send(myJSON);  
	//console.log(myJSON);
}

function updateSlider(key, value){
	document.getElementById(key).innerHTML = value;
	var field = key;
	var obj = {};
	obj[field] = value;
	var myJSON = JSON.stringify(obj);
	websocket.send(myJSON);
	//console.log(myJSON);	
}

function updateButton(key, value) {
	var field = key;
	var obj = {};
	obj[field] = value;
	var myJSON = JSON.stringify(obj);
	websocket.send(myJSON);
	//console.log(myJSON);
}

function updateTime(key1, value1, key2, value2) {
	var field = key1;
	var field2 = key2;
	var obj = {};
	var obj2 = {};
	
	document.getElementById(key1).innerHTML = value1;
	document.getElementById(key2).innerHTML = value2;

	obj[field] = value1;
	obj2[field2] = value2;
	Object.assign(obj, obj2);

	var myJSON = JSON.stringify(obj);
	websocket.send(myJSON); 
	//console.log(myJSON); 
}

 
// Called when a message is received from the server
function onMessage(event) {

 
    // Print out our received message
    // console.log("Received: " + event.data);
let data = JSON.parse(event.data);
//var string = event.data;
console.log(data);
		
</script>	

<script src="https://code.highcharts.com/highcharts.js"></script>

<script>
 	var chartT1 = new Highcharts.Chart({
            chart: { renderTo : 'chart-temperature1',
					backgroundColor: '#808080',
			},
            title: { text: 'Temperature History',
						style: {color: '#ffffff',}
					},
            series: [
                {
                    showInLegend: true,
                    name: 'Soil temp',
                    data: [],
                    color: '#ff0000'
                }, 
                {
                    showInLegend: true,
                    name: 'target Temp',
                    data: [], 
                    color: '#0000ff'
                },
				{
                    showInLegend: true,
                    name: 'Air temp',
                    data: [],
                    color: '#ffff00'
                },
				{
                    showInLegend: true,
                    name: 'fan %',
                    data: [], 
                    color: '#00ff00'
                },
				{
                    showInLegend: true,
                    name: 'humidity %',
                    data: [], 
                    color: '#00ffff'
                }

            ],
			tooltip: {
				valueSuffix: '\xB0 C'
			},
			 plotOptions: {
				line: {
					lineWidth: 2,
					states: {
						hover: {
							lineWidth: 3
						}
					},
					
					marker: {
						enabled: false
					}
					
				}
			},
			legend: {
				itemStyle: {
					color: 'white'
				}  
			},
            xAxis: { 
               type: 'datetime',
               dateTimeLabelFormats: { second: '%H:%M:%S' },
			   title: { style: {color:"#ffffff"}},
			   labels: { style: {color:"#ffffff"}}
            },
            yAxis: {
                title: { text: 'Temperature (Celsius)',
						 style: {color:"#ffffff"}},
				labels: { style: {color:"#ffffff"}}
            },
            credits: { enabled: false }
        });
function drawChart1(temp){
            var x = (new Date()).getTime();
			var currentCelsius = parseFloat(temp1);
			var currentAirCelsius = parseFloat(airtemp1);
			var currentFanSpeed = parseFloat(fanSpeed1);
			var currentHumidity = parseFloat(humidity1);
			if(chartT1.series[0].data.length > 1440) {
				chartT1.series[0].addPoint([x, currentCelsius], true, true, true);
				chartT1.series[2].addPoint([x, currentAirCelsius], true, true, true);
				chartT1.series[3].addPoint([x, currentFanSpeed], true, true, true);
				chartT1.series[4].addPoint([x, currentHumidity], true, true, true);
			} else {
				chartT1.series[0].addPoint([x, currentCelsius], true, false, true);
				chartT1.series[2].addPoint([x, currentAirCelsius], true, true, true);
				chartT1.series[3].addPoint([x, currentFanSpeed], true, false, true);
				chartT1.series[4].addPoint([x, currentHumidity], true, false, true);
			}
            if (targetCelsius1 > 0) {
                if(chartT1.series[1].data.length > 1440) {
                    chartT1.series[1].addPoint([x, targetCelsius1], true, true, true);
                } else {
                    chartT1.series[1].addPoint([x, targetCelsius1], true, false, true);
                }
            }
			
//function drawChart1(temp
};

 	var chartT2 = new Highcharts.Chart({
            chart: { renderTo : 'chart-temperature2',
					backgroundColor: '#808080',
			},
            title: { text: 'Temperature History',
						style: {color: '#ffffff',}
					},
            series: [
				{
                    showInLegend: true,
                    name: 'Soil temp2',
                    data: [],
                    color: '#ff0000'
                }, 
                {
                    showInLegend: true,
                    name: 'target Temp2',
                    data: [], 
                    color: '#0000ff'
                },
				{
                    showInLegend: true,
                    name: 'Air temp2',
                    data: [],
                    color: '#ffff00'
                },
				{
                    showInLegend: true,
                    name: 'fan2 %',
                    data: [], 
                    color: '#00ff00'
                },
				{
                    showInLegend: true,
                    name: 'humidity2 %',
                    data: [], 
                    color: '#00ffff'
                }

            ],
			tooltip: {
				valueSuffix: '\xB0 C'
			},
			 plotOptions: {
				line: {
					lineWidth: 2,
					states: {
						hover: {
							lineWidth: 3
						}
					},
					
					marker: {
						enabled: false
					}
					
				}
			},
			legend: {
				itemStyle: {
					color: 'white'
				}  
			},
            xAxis: { 
               type: 'datetime',
               dateTimeLabelFormats: { second: '%H:%M:%S' },
			   title: { style: {color:"#ffffff"}},
			   labels: { style: {color:"#ffffff"}}
            },
            yAxis: {
                title: { text: 'Temperature (Celsius)',
						 style: {color:"#ffffff"}},
				labels: { style: {color:"#ffffff"}}
            },
            credits: { enabled: false }
        });
function drawChart2(temp){
            var x = (new Date()).getTime();
			var currentCelsius = parseFloat(temp2);
			var currentAirCelsius = parseFloat(airtemp2);
			var currentFanSpeed = parseFloat(fanSpeed2);
			var currentHumidity = parseFloat(humidity2);
			if(chartT2.series[0].data.length > 1440) {
				chartT2.series[0].addPoint([x, currentCelsius], true, true, true);
				chartT2.series[2].addPoint([x, currentAirCelsius], true, true, true);
				chartT2.series[3].addPoint([x, currentFanSpeed], true, true, true);
				chartT2.series[4].addPoint([x, currentHumidity], true, true, true);
			} else {
				chartT2.series[0].addPoint([x, currentCelsius], true, false, true);
				chartT2.series[2].addPoint([x, currentAirCelsius], true, true, true);
				chartT2.series[3].addPoint([x, currentFanSpeed], true, false, true);
				chartT2.series[4].addPoint([x, currentHumidity], true, false, true);
			}
            if (targetCelsius1 > 0) {
                if(chartT2.series[1].data.length > 1440) {
                    chartT2.series[1].addPoint([x, targetCelsius1], true, true, true);
                } else {
                    chartT2.series[1].addPoint([x, targetCelsius1], true, false, true);
                }
            }
			
//function drawChart1(temp
};
</script>

<script>
	function blockSound1(numberofRings, timerCounter){
		if (timerCounter >= numberofRings){
		clearInterval(refreshIntervalId1);
		document.getElementById("1I1").checked = false;
		//console.log("switches alarm sign off");
		}
	}
</script>

<script>
/*
function setTab(fixedVariable) {
  var x = document.getElementById(fixedVariable);
  if (x.style.display === "none") {
    x.style.display = "block";
  } else {
    x.style.display = "none";
  }
}
*/
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>

<script>
function updateTime(){
        var momentNow = moment();
        $('#date-part').html(momentNow.format('YYYY MMMM DD') + ' '
                            + momentNow.format('dddd')
                             .substring(0,3).toUpperCase());
        $('#time-part').html(momentNow.format('HH:mm:ss'));
		
		var currentD = new Date();
		var startLights = new Date();
		startLights.setHours(hourStart,minuteStart);
		
		var endLights = new Date();
		endLights.setHours(hourStop,minuteStop); 

		if(currentD >= startLights && currentD < endLights ){
			if (document.getElementById("1L2").checked == false){
				doSend('1L2'+1);
			}
		}
		else{
			if (document.getElementById("1L2").checked == true)
			doSend('1L2'+0);
			}

		var startLights2 = new Date();
		startLights2.setHours(hourStart2,minuteStart2);
		
		var endLights2 = new Date();
		endLights2.setHours(hourStop2,minuteStop2); 

		if(currentD >= startLights2 && currentD < endLights2 ){
			if (document.getElementById("1L6").checked == false){
				doSend('1L6'+1);
			}
		}
		else{
			if (document.getElementById("1L6").checked == true)
			doSend('1L6'+0);
			}

		
		}
</script>

  
</body>